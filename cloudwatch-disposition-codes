// CloudWatch Custom Widget sample: display CloudWatch metric data as a table
const AWS = require('aws-sdk');
const docClient = new AWS.DynamoDB.DocumentClient();
let recordTableName = process.env.RecordTableName;

exports.handler = async (event, context, callback) => {
    const params = {
        TableName: recordTableName
    };
    let dispositionCodes = [];
    let contactIdLength;
    let html = "<html><body><table><tr><td style=\"border:1px solid black;\"><b>Disposition Codes</b></td><td style=\"border:1px solid black;\"><b>Count</b></td></tr>";
    
    let records = await docClient.scan(params).promise();
    console.log("Records length: " + records.Count);
    for (var j = 0; j < records.Count; j++) {
        if (dispositionCodes.includes(records.Items[j].dispositionCode)) {
            console.log("dispositionCode exists: " + records.Items[j].dispositionCode);
        }
        else {
            console.log("dispositionCode new: " + records.Items[j].dispositionCode);
            
            contactIdLength = await getContactIds(records.Items[j].dispositionCode);
            console.log("dispositionCode: " + records.Items[j].dispositionCode + " | ContactIds: " + contactIdLength);
            html = html + "<tr><td style=\"border:1px solid black;\">" + records.Items[j].dispositionCode + "</td>" + "<td style=\"border:1px solid black;\">" + contactIdLength + "</td></tr>";
            dispositionCodes.push(records.Items[j].dispositionCode);
        }
    }

    html = html + "</table></html>";
    return html;    
};


async function getContactIds(dispositionCode)
{
	try 
	{
		var paramsQuery = {
			TableName: recordTableName,
			IndexName: "dispositionCode-index",
  			KeyConditionExpression: "dispositionCode = :a",
  			ExpressionAttributeValues: {
   				":a": dispositionCode
  			}
 		};
		var data = await docClient.query(paramsQuery).promise();
//		console.log("Data: " + JSON.stringify(data));
		return data.Count;
	} 
	catch (error) 
	{
		console.error('getContactIds | Failed to query', error);
		return false;
	}
}
