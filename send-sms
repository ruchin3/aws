var https = require('https');
var queryString = require('querystring');
var accountSid = process.env.AccountSid;
var authToken = process.env.AuthToken;
var fromNumber = process.env.FromNumber;

exports.handler = function (event, context, callback) {
    
    console.log("Customer number: " + event.Details.ContactData.CustomerEndpoint.Address);
    console.log("SmsBody: " + event.Details.Parameters.SmsBody);

    var message = {
        To: event.Details.ContactData.CustomerEndpoint.Address, 
        From: fromNumber,
        Body: event.Details.Parameters.SmsBody
    };
    
    var messageString = queryString.stringify(message);
    var auth = 'Basic ' + Buffer.from(accountSid + ':' + authToken).toString('base64');

    var options = {
        host: 'api.twilio.com',
        port: 443,
        path: '/2010-04-01/Accounts/' + accountSid + '/Messages.json',
        method: 'POST',
        headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': auth
                 }
    };

    var req = https.request(options, function(res) {
        var responseString = '';
        res.on('data', function (data) {
            responseString += data;
        });
            
        res.on('end', function () {
            console.log('Twilio Response: ' + responseString);
            var result = JSON.parse(responseString);
            console.log('SMS Status: ' + result.status);
            callback(null, buildResponse(result.status));
        });
    });
    
    req.on('error', function(e) {
        console.error('HTTP error: ' + e.message);
    });
    
    req.write(messageString);
    req.end();
    
};

function buildResponse(status) {
  		return { 
			status: status
		};
}
