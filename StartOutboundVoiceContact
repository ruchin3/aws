var AWS = require('aws-sdk');
const crypto = require('crypto');
const connect = new AWS.Connect();

exports.handler = function (event) {

    var clientToken = crypto.randomUUID(); 
    
    console.log("Event: " + JSON.stringify(event));
    console.log("CallbackNumber: " + event.CallbackNumber);
    console.log("Dynamic Queue: " + event.DynamicQueue);
    console.log("Queue Priority: " + event.QueuePriority);
    console.log("Callback Attempt: " + event.CallbackAttempt);

    
    var params = {
        InstanceId: process.env.InstanceId,
        ContactFlowId: process.env.ContactFlowId,
        DestinationPhoneNumber: event.CallbackNumber,
        Attributes: {
            'CallbackAttempt': event.CallbackAttempt,
            'CallbackNumber': event.CallbackNumber,
            'DynamicQueue': event.DynamicQueue, 
            'clientToken': clientToken
        },
        QueueId: process.env.QueueId
    };

    console.log("startOutboundVoiceContact | Params: " + JSON.stringify(params));

    connect.startOutboundVoiceContact(params, function (err, data) {
        if (err) {
            console.log(err, err.stack);
            console.log("startOutboundVoiceContact | Unable to create outbound call");
            return false;
        } else {
          console.log("Contact ID: " + data.ContactId);
          return data.ContactId;
        }
    }); 
};
