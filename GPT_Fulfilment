const axios = require('axios');

exports.handler = async(event, context) =>
{
  try
  {

    var promptEngineeringInput = `You are a super helpful and perky smart processor that handles contact centre enquires and you only produce json output like this:
{
"topic": "access | software | laptop | password | system outage | network | theft | loss | order | accessories | unknown",
"summary": "It sounds like you are having issues with logging in"
}

The topic should match the overall customer topic from one of the provided values and the summary should be a statement that can be read back to the customer summarising their enquiry.

It is very important that you only use one of the topics from the list above!

If you don't find a primary topic from the list use the topic: "unknown"

Transcript:From this morning, can't log in and I think I need a reset of my password.
Output:{"topic":"password", "summary": "It sounds like you are having issues logging and need assistance resetting your password."}
Transcript:I need a password reset
Output:{"topic":"password", "summary": "It sounds like you need help resetting your password."}
Transcript:I can't log into salesforce today
Output:{"topic":"access", "summary": "It sounds like you are having issues logging into salesforce." }
Transcript:I need access to teams
Output:{"topic":"access", "summary": "It sounds like you need assistance getting access to teams." }
Transcript:website is down
Output:{"topic":"system outage", "summary": "It sounds like you have detected a system outage you want to report."}
Transcript:Looks like production is down again
Output:{"topic":"system outage", "summary": "It sounds like you have detected a system outage you want to report."}
Transcript:Can you order me a new keyboard and mouse?
Output:{"topic":"order", "summary": "It sounds like you want to order a computer peripheral."}
Transcript: My keyboard is not working
Output:{"topic":"accessories", summary: "It sounds like you are having issues with your keyboard."}
Transcript: My laptop was stolen
Output:{"topic":"theft", "summary": "It sounds like you want to report the theft of laptop."}
Transcript: I lost my phone!
Output:{"topic": "loss", "summary": "It sounds like you want to report the loss of your phone."}
Transcript:I need an Office 365 key
Output:{"topic": "software", "summary": "It sounds like you need assistance with software."}

Now you try, emit the JSON for this input transcript:

Transcript:`;

    var suffix = `\nOutput:`;

    var chatGPTPrompt = `${promptEngineeringInput}${event.inputTranscript}${suffix}`;

    console.info(`Sending ChatGPT prompt: ${chatGPTPrompt}`);

    var chatGPTResponse = await makeChatGPTRequest(chatGPTPrompt);

  }
  catch (error)
  {
    console.error('Failed to fulfil Lex bot', error);
    throw error;
  }
};

async function makeChatGPTRequest(prompt)
{
  try
  {
    var options = {
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${process.env.CHAT_GPT_KEY}`
      }
    };

    console.info(`Options: ${JSON.stringify(options, null, 2)}`);

    var body = {
      model: 'gpt-3.5-turbo',
      messages: [{role: 'user', content: prompt}]
    };

    var response = await axios.post(process.env.CHAT_GPT_URL, body, options);

    console.info(`Got chatgpt response: ${JSON.stringify(response.data, null, 2)}`);

    try
    {
      var jsonText = response.data.choices[0].message.content.trim();

      console.log("Response: " + JSON.parse(jsonText));
    
    }
    catch (error)
    {
      console.error('Failed to read response', error);
      return {
        topic: 'unknown',
        summary: `I'm sorry could you word that differently and try again?`
      };
    }
    
  }
  catch (error)
  {
    console.error('Failed to inference on ChatGPT', error);
    return {
      topic: 'unknown',
      summary: `I'm sorry could you word that differently and try again?`
    };
  }
}
